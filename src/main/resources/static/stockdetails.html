<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stock Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div id="sidebar-container"></div>


<!-- Main Content -->
<div class="content">
    <div class="content container mt-4">
        <!-- Back button -->
        <div class="d-flex justify-content mb-3">
            <a href="financialinstruments.html" class="btn btn-light btn-lg btn-dark-border"> ‚¨ÖÔ∏è Back </a>
        </div>
        <h2 id="stockName" class="mb-2">üìà Stock Details</h2>
        <p><strong>Ticker:</strong> <span id="stockTicker"></span></p>
        <p><strong>Current Price:</strong> <span id="stockPrice"></span></p>
        <canvas id="historyChart" width="600" height="300"></canvas>
        <div id="noHistoryContainer" style="display:none; margin-top: 10px;">
            <div class="alert alert-warning">
                We were unable to load history for this instrument. You can Edit this instrument or Delete it from the Stock Base.
            </div>
            <button id="editStockBtn" class="btn btn bg-primary bg-opacity-10 text-primary border border-primary">Edit</button>
            <button id="removeStockBtn" class="btn btn bg-danger bg-opacity-10 text-danger border border-danger">Remove</button>
        </div>
        <!-- Hidden field for current value - should be displayed while clicking on Edit button -->
        <div id="currentValueManual" style="display:none; margin-top:10px;">
            <div class="mb-3">
                <label for="currentValue"  class="form-label">Enter Current Value for this Financial Instrument:</label>
                <input type="number" id="currentValue" step="0.01" class="form-select"/>
            </div>
            <button id="submitCurrentValue" class="btn bg-primary bg-opacity-10 text-primary border border-primary">Save Value</button>
        </div>
        <div id="responseMessage"></div>
    </div>
</div>


<script>
    // Sidebar
    fetch("sidebar.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("sidebar-container").innerHTML = data;
        })
        .catch(err => console.error("Sidebar load error:", err));

    // Get stock id from URL
    const params = new URLSearchParams(window.location.search);
    const stockId = params.get("id");

    // Fetch stock with history
    fetch(`/stocks/${stockId}`)
        .then(res => res.json())
        .then(stock => {
            document.getElementById("stockName").textContent = stock.name;
            document.getElementById("stockTicker").textContent = stock.ticker;
            document.getElementById("stockPrice").textContent = stock.currentValue + " PLN";


            const labels = stock.historicalValues.map(v => v.date);
            const values = stock.historicalValues.map(v => v.closeValue);

            const noHistoryContainer = document.getElementById("noHistoryContainer");
            const ctx = document.getElementById('historyChart').getContext('2d');

            if (!stock.historicalValues || stock.historicalValues.length === 0) {

                document.getElementById('historyChart').style.display = 'none';
                noHistoryContainer.style.display = 'block';

                // Edit Stock
                document.getElementById("editStockBtn").onclick = function() {

                    //Show form to update current value
                    document.getElementById("currentValueManual").style.display = "block";

                    // Current Value Update
                    document.getElementById("submitCurrentValue").onclick = function() {
                        const manualValue = parseFloat(document.getElementById("currentValue").value);
                        if (isNaN(manualValue) || manualValue <= 0) {
                            alert("Please enter a valid value");
                            return;
                        }

                        // call PATCH to update current value
                        fetch(`/stocks/${stock.id}`, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ currentValue: manualValue })
                        })
                            .then(async res => {
                                if (res.ok) return res.json();
                                else {
                                    const errorText = await res.text();
                                    throw new Error(errorText || "Failed to update Financial Instrument");
                                }

                            })
                            .then(updated => {
                                document.getElementById("responseMessage").innerHTML =
                                    `<div class="alert alert-success" style="margin-top: 15px;">Instrument updated with current value: ${updated.currentValue}</div>`;
                                document.getElementById("currentValueManual").style.display = "none";
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            })
                            .catch(err => {
                                document.getElementById("responseMessage").innerHTML =
                                    `<div class="alert alert-danger">${err.message}</div>`;
                            });
                    };
                };

                // Delete stock
                document.getElementById("removeStockBtn").onclick = function() {
                    if (!confirm("Are you sure you want to remove this stock?")) return;

                    fetch(`/stocks/${stock.id}`, {
                        method: "DELETE"
                    })
                        .then(res => {
                            if (res.ok) {
                                alert(`Stock "${stock.name}" removed successfully`);
                                window.location.href = "/financialinstruments.html"; // go back to stock list
                            } else {
                                return res.text().then(text => { throw new Error(text) });
                            }
                        })
                        .catch(err => alert("Error removing stock: " + err.message));
                };

            } else {
                // Display chart when history is present
                const labels = stock.historicalValues.map(v => v.date);
                const values = stock.historicalValues.map(v => v.closeValue);

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Close Price',
                            data: values,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }
        })
        .catch(err => console.error("Error loading stock:", err));
</script>
</body>
</html>