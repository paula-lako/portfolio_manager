<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Financial Instruments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<!-- Sidebar placeholder -->
<div id="sidebar-container"></div>

<!-- Main Content -->
<div class="content">
    <h2 class="mb-4">üè¶ Available Financial Instruments</h2>

    <!-- Search field -->
    <div class="mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by ticker, name or type ...">
    </div>

    <table class="table table-striped table-bordered">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Ticker</th>
            <th>Name</th>
            <th>Type</th>
            <th>Current Price</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="financialInstrumentsTable">
        <!-- Rows will be injected dynamically -->
        </tbody>
    </table>
</div>

<script>

    //Load sidebar dynamically
    fetch("sidebar.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("sidebar-container").innerHTML = data;
        })
        .catch(err => console.error("Sidebar load error:", err));


    //Load stocks from backend
    fetch("/stocks")
        .then(response => response.json())
        .then(stocks => {
            const tableBody = document.getElementById("financialInstrumentsTable");
            tableBody.innerHTML = "";

            //List of all stocks
            let allStocks = stocks;

            function renderTable(filteredStocks) {
                tableBody.innerHTML = "";
                filteredStocks.forEach(stock => {
                    const row = `
                        <tr>
                            <td>${stock.id}</td>
                            <td>
                               <a href="stockdetails.html?id=${stock.id}">${stock.ticker}</a>
                            </td>
                            <td>${stock.name}</td>
                            <td>${stock.stockType ?? '-'}</td>
                            <td>${stock.currentValue} PLN</td>
                             <td>
                                <button class="btn btn-sm btn-primary add-btn"
                                        data-ticker="${stock.ticker}"
                                        data-price="${stock.currentValue}">
                                    Add
                                </button>
                             </td>
                        </tr>`;
                    tableBody.insertAdjacentHTML("beforeend", row);
                });
            }

            //Render of whole list
            renderTable(allStocks);

            //Filter logic for Search Input
            const searchInput = document.getElementById("searchInput");
            searchInput.addEventListener("input", () => {
                const query = searchInput.value.toLowerCase();
                const filtered = allStocks.filter(stock =>
                    stock.ticker.toLowerCase().includes(query) ||
                    stock.name.toLowerCase().includes(query) ||
                    (stock.stockType ?? "").toLowerCase().includes(query)
                );
                renderTable(filtered);
            });

            //Add button logic
            tableBody.addEventListener("click", (e) => {
                if (e.target.classList.contains("add-btn")) {
                    const ticker = e.target.getAttribute("data-ticker");
                    const price = e.target.getAttribute("data-price");
                    const today = new Date().toISOString().slice(0, 10); // yyyy-mm-dd
                    const url = `addtransaction.html?ticker=${encodeURIComponent(ticker)}&price=${encodeURIComponent(price)}&date=${today}&type=BUY`;
                    window.location.href = url;
                }
            });
        })
        .catch(err => console.error("Error loading stocks:", err));
</script>
</body>
</html>
